!function(e){function t(a){if(r[a])return r[a].exports;var n=r[a]={exports:{},id:a,loaded:!1};return e[a].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t){"use strict";function r(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}!function(e,t,a){function n(e){return""+e[0].toUpperCase()+e.slice(1)}function o(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,new Error(t)}function i(e,t){var r=t.twitter,a=t.foursquare;return"\n      <div>\n        "+e+"\n        <br>\n        "+r.statuses+"\n        <br>\n        "+a.usercount+"\n      </div>\n    "}function c(t,r,a){return e('\n        <li>\n          <span class="fa fa-times delete"></span>\n          <span>'+n(t)+": "+n(r)+" - "+n(a)+"</span>\n        </li>").data("type",t).data("area",r).data("name",a)}function s(e){var r={statuses:e.twitter_statuses||0},a={usercount:e.foursquare_usercount||0};return t.marker([e.lat,e.lon]).bindPopup(i(e.ds_pdv,{twitter:r,foursquare:a}))}function l(e){return h.filter(function(t){var r=!0,a=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var c=o.value;if(t[c.area].toLowerCase()===c.name)return!0}}catch(s){a=!0,n=s}finally{try{!r&&i["return"]&&i["return"]()}finally{if(a)throw n}}return!1}).filter(function(e){return e.lat&&e.lon}).map(s)}function u(e,t,r){return h.filter(function(e){return e.lat&&e.lon&&e[r]}).filter(function(r){return r[e].toLowerCase()===t}).map(function(e){return[e.lat,e.lon,e[r]]})}function f(){return fetch("./api/v1/token",{credentials:"same-origin"}).then(o).then(function(e){return e.text()})}function d(e,t,a){return fetch("./api/v1/venues?area="+t+"&name="+a+"&token="+e).then(o).then(function(e){return e.json()}).then(function(e){var n=h.map(function(e){return e.cd_pdv}),o=e.filter(function(e){return-1===n.indexOf(e.cd_pdv)});h.push.apply(h,r(o)),y.push({area:t,name:a})})}function m(e,t,r,a){return fetch("./api/v1/map?area="+t+"&name="+r+"&gran="+a+"&token="+e).then(o).then(function(e){return e.json()}).then(function(e){return C.push({area:t,name:r,gran:a,shapes:e})})}function v(e){return e>1e3?"#800026":e>500?"#BD0026":e>200?"#E31A1C":e>100?"#FC4E2A":e>50?"#FD8D3C":e>20?"#FEB24C":e>10?"#FED976":"#FFEDA0"}function p(){e(".control .markers").find("#marker-city").prop("checked",!0),e(".control .markers").find(".name").val(""),e(".select .markers").removeClass("active"),e(".control .markers").removeClass("active"),e(".control").removeClass("active"),e(".control .heatmaps").find("#heatmap-city").prop("checked",!0),e(".control .heatmaps").find(".name").val(""),e(".control .heatmaps").find(".variable").val(""),e(".select .heatmaps").removeClass("active"),e(".control .heatmaps").removeClass("active"),e(".control").removeClass("active"),e(".control .geometry").find("#geometry-city").prop("checked",!0),e(".control .geometry").find(".name").val(""),e(".control .geometry").find(".gran").val(""),e(".select .geometry").removeClass("active"),e(".control .geometry").removeClass("active"),e(".control").removeClass("active")}var g=Object.freeze({markers:"markers",heatmaps:"heatmaps",geometry:"geometry"}),h=[],y=[],C=[];e(document).foundation();var k=t.map("map",{zoomControl:!1}).setView([40.417049,-3.703525],6);t.control.zoom({position:"bottomleft"}).addTo(k);var b=t.control();b.onAdd=function(e){return this._div=t.DomUtil.create("div","info"),this.update(),this._div},b.update=function(e){var t="";if(e)for(var r in e)e.hasOwnProperty(r)&&(t+=r+": "+e[r]+"<br>");else t="Hover over an area";this._div.innerHTML="<h4>Area Data</h4>"+t};var w=t.control({position:"bottomright"});w.onAdd=function(e){for(var r=t.DomUtil.create("div","info legend"),a=[0,10,20,50,100,200,500,1e3],n=0;n<a.length;n++)r.innerHTML+='\n        <i style="background:'+v(a[n]+1)+'"></i>\n        <span>'+a[n]+(a[n+1]?"&ndash;"+a[n+1]+"<br>":"+")+"</span>";return r},t.TopoJSON=t.GeoJSON.extend({addData:function(e){if("Topology"===e.type)for(var r in e.objects){var n=a.feature(e,e.objects[r]);t.GeoJSON.prototype.addData.call(this,n)}else t.GeoJSON.prototype.addData.call(this,e);return this}}),t.topoJson=function(e,r){return new t.TopoJSON(e,r)};var D=(t.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',id:"mapbox.light",accessToken:"pk.eyJ1IjoibXluZGZsYW1lIiwiYSI6ImNpbXJ1am85cDAwNGx2OW0xbnU0amdkZHgifQ.56NzZw6OPm41VEqhaqGHAA"}).addTo(k),t.markerClusterGroup({disableClusteringAtZoom:18}).addTo(k)),T=[],x=[],L=f();e(".select").on("click",".markers",function(t){t.preventDefault(),e(t.currentTarget).addClass("active").siblings().removeClass("active"),e(".control .markers").addClass("active").siblings().removeClass("active"),e(".control").addClass("active")}).on("click",".markers.active",function(t){t.preventDefault(),e(t.currentTarget).removeClass("active").siblings().removeClass("active"),e(".control .markers").removeClass("active").siblings().removeClass("active"),e(".control").removeClass("active")}).on("click",".heatmaps",function(t){t.preventDefault(),e(t.currentTarget).addClass("active").siblings().removeClass("active"),e(".control .heatmaps").addClass("active").siblings().removeClass("active"),e(".control").addClass("active")}).on("click",".heatmaps.active",function(t){t.preventDefault(),e(t.currentTarget).removeClass("active").siblings().removeClass("active"),e(".control .heatmaps").removeClass("active").siblings().removeClass("active"),e(".control").removeClass("active")}).on("click",".geometry",function(t){t.preventDefault(),e(t.currentTarget).addClass("active").siblings().removeClass("active"),e(".control .geometry").addClass("active").siblings().removeClass("active"),e(".control").addClass("active")}).on("click",".geometry.active",function(t){t.preventDefault(),e(t.currentTarget).removeClass("active").siblings().removeClass("active"),e(".control .geometry").removeClass("active").siblings().removeClass("active"),e(".control").removeClass("active")}),e(".controls .layers").on("click",".delete",function(t){t.preventDefault();var a=e(t.currentTarget).parent().data("type"),n=e(t.currentTarget).parent().data("area"),o=e(t.currentTarget).parent().data("name");switch(a){case g.markers:e(t.currentTarget).parent().remove();var i=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===a});D.clearLayers(),D.addLayers(l(i));break;case g.heatmaps:var c=T.reduce(function(e,t,r){return t.area===n&&t.name===o?r:e},-1);-1!==c&&(k.removeLayer(T[c].heatmap),T=[].concat(r(T.slice(0,c)),r(T.slice(c+1))),e(t.currentTarget).parent().remove());break;case g.geometry:var s=x.reduce(function(e,t,r){return t.area===n&&t.name===o?r:e},-1);-1!==s&&(k.removeLayer(x[s].geometry),x=[].concat(r(x.slice(0,s)),r(x.slice(s+1))),e(t.currentTarget).parent().remove()),k.removeControl(b),k.removeControl(w),k.setView([40.417049,-3.703525],6)}}),e(".control .markers").on("click",".advanced",function(e){e.preventDefault()}).on("click",".add",function(t){t.preventDefault();var r=g.markers,a=e(".control .markers").find('input[type="radio"]:checked').val().trim().toLowerCase(),n=e(".control .markers").find(".name").val().trim().toLowerCase();if(a&&n){var o=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===r});if(!o.find(function(e){return e.area===a&&e.name===n})){e(".loading").toggle();var i=y.find(function(e){return e.area===a&&e.name===n})?Promise.resolve():L.then(function(e){return d(e,a,n)});i.then(function(){o.push({type:r,area:a,name:n}),D.clearLayers(),D.addLayers(l(o)),k.fitBounds(D.getBounds()),e(".controls .layers").find("ul").append(c(r,a,n)),p(),e(".loading").toggle()})["catch"](function(){return e(".loading").toggle()})}}}).on("click",".cancel",function(e){e.preventDefault(),p()}),e(".control .heatmaps").on("click",".advanced",function(e){e.preventDefault()}).on("click",".add",function(a){if(a.preventDefault(),0!==e(".control .heatmaps").find(".variable").prop("selectedIndex")){var n=g.heatmaps,o=e(".control .heatmaps").find('input[type="radio"]:checked').val().trim().toLowerCase(),i=e(".control .heatmaps").find(".name").val().trim().toLowerCase(),s=e(".control .heatmaps").find(".variable").val().trim().toLowerCase();if(o&&i&&s){var l=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===n});if(!l.find(function(e){return e.area===o&&e.name===i})){e(".loading").toggle();var f=y.find(function(e){return e.area===o&&e.name===i})?Promise.resolve():L.then(function(e){return d(e,o,i)});f.then(function(){var a=u(o,i,s),l=Math.max.apply(Math,r(a.map(function(e){return e[2]}).sort(function(e,t){return t-e}).slice(.1*a.length))),f=t.heatLayer(a,{radius:25,max:l});f.addTo(k),T.push({area:o,name:i,heatmap:f}),e(".controls .layers").find("ul").append(c(n,o,i)),p(),e(".loading").toggle()})["catch"](function(){return e(".loading").toggle()})}}}}).on("click",".cancel",function(e){e.preventDefault(),p()}),e(".control .geometry").on("click",".advanced",function(e){e.preventDefault()}).on("click",".add",function(r){if(r.preventDefault(),0!==e(".control .geometry").find(".variable").prop("selectedIndex")){var a=g.geometry,n=e(".control .geometry").find('input[type="radio"]:checked').val().trim().toLowerCase(),o=e(".control .geometry").find(".name").val().trim().toLowerCase(),i=e(".control .geometry").find(".gran").val().trim().toLowerCase(),s=e(".control .geometry").find(".variable").val().trim().toLowerCase();if(n&&o&&i&&s){var l=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===a});if(!l.length){e(".loading").toggle();var u=-1===C.filter(function(e){return e.area===n}).map(function(e){return e.name}).indexOf(o)?L.then(function(e){return m(e,n,o,i)}):Promise.resolve();u.then(function(){var r=C.find(function(e){return e.area===n&&e.name===o&&e.gran===i}).shapes,l=t.topoJson(null,{onEachFeature:function(e,r){r.on({mouseover:function(e){e.target.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.7}),t.Browser.ie||t.Browser.opera||e.target.bringToFront(),b.update(e.target.feature.properties)},mouseout:function(e){l.resetStyle(e.target),b.update()},click:function(e){k.fitBounds(e.target.getBounds())}})},style:function(e){return{fillColor:v(e.properties[s]),fillOpacity:.7,weight:1,opacity:1,color:"white",dashArray:"3"}}}).addData(r).addTo(k);x.push({area:n,name:o,geometry:l}),b.addTo(k),w.addTo(k),k.fitBounds(l.getBounds()),e(".controls .layers").find("ul").append(c(a,n,o)),p(),e(".loading").toggle()})["catch"](function(){return e(".loading").toggle()})}}}}).on("click",".cancel",function(e){e.preventDefault(),p()})}($,L,topojson)}]);