"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var a=0,r=Array(e.length);a<e.length;a++)r[a]=e[a];return r}return Array.from(e)}!function(e,a,r,o){function n(e){for(var a=[],r=e/(w.classes-1),o=0;o<=w.classes-1;o++)a.push(r*o);return a}function t(){return Object.keys(o).filter(function(e){return"sequential"===w.type?["Blues","Greens","Greys","Oranges","Purples","Reds","BuGn","BuPu","GnBu","OrRd","PuBu","PuBuGn","PuRd","RdPu","YlGn","YlGn","YlGnBu","YlOrBr","YlOrRd"].indexOf(e)>=0:"diverging"===w.type?["BrBG","PiYG","PRGn","PuOr","RdBu","RdGy","RdYlBu","RdYlGn","Spectral"].indexOf(e)>=0:"qualitative"===w.type?["Accent","Dark2","Paired","Pastel1","Pastel2","Set1","Set2","Set3"].indexOf(e)>=0:!1}).map(function(e,a,r){var n=o[e][5],t="";return 0===a&&(t+='<ul class="menu dropdown" data-dropdown-menu><li class="is-dropdown-submenu-parent"><a href="#">Colors</a><ul class="menu">'),"YlGn"===e?(t+='<li class="is-dropdown-submenu-parent"><a href="#">Multi-hue</a><ul class="menu">',t+='<li><a href="#" class="color-name '+e+'"><div class="color-container">',t+=n.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"):"Purples"===e?(t+="</ul></li>",t+='<li class="is-dropdown-submenu-parent"><a href="#">Single hue</a><ul class="menu">',t+='<li><a href="#" class="color-name '+e+'"><div class="color-container">',t+=n.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"):(t+='<li><a href="#" class="color-name '+e+'"><div class="color-container">',t+=n.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"),a===r.length-1&&(t+="</ul></li>",t+="</ul></li></ul>"),t}).join("")}function i(e){var a=o[w.color][w.classes];return j.reduce(function(r,o,n){return e>=o?a[n]:r},a[0])}function s(e){return{fillColor:i(e.properties.demography[G]),weight:1,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}function l(a){var r=a.target;r.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.7}),e.Browser.ie||e.Browser.opera||r.bringToFront(),g.update(r.feature.properties)}function c(e){h.resetStyle(e.target),g.update()}function u(e){var a=e?e.granularity||null:null,t=e?e.variable||null:null;if(C=a,G=t,h.clearLayers(),m.removeControl(k),a!==f.empty){var i=Object.keys(f)[a],s=Object.keys(O[i].objects)[0];j=n(G===y.pmen||G===y.pforeigners?1:O[i].objects[s].geometries.reduce(function(e,a){return Math.max(a.properties.demography[t],e)},0)),h.addData(O[i])}a!==f.empty&&t!==y.empty&&m.addControl(k);var l=Math.max.apply(Math,_toConsumableArray(Object.keys(o[w.color]))),c=2;x.classes.find(".color-classes").each(function(e,a){var o=r(a).find("a");l>=e+c+1?o.removeClass("disabled"):o.addClass("disabled")})}function d(e){m.fitBounds(e.target.getBounds()),C<Object.keys(f).length-1&&u({granularity:C+1,variable:G})}function p(e,a){a.on({mouseover:l,mouseout:c,click:d})}r(document).foundation(),e.TopoJSON=e.GeoJSON.extend({addData:function(r){if("Topology"===r.type)for(var o in r.objects){var n=a.feature(r,r.objects[o]);e.GeoJSON.prototype.addData.call(this,n)}else e.GeoJSON.prototype.addData.call(this,r);return this}}),e.topoJson=function(a,r){return new e.TopoJSON(a,r)};var f=Object.freeze({empty:-1,ccaa:1,provincias:2,neighbourhoods:3,censussections:4}),y=Object.freeze({empty:"empty",population:"poblacion",pmen:"prop_hombres",pforeigners:"prop_origen_extranjero"}),m=void 0,v=void 0,h=void 0,b=void 0,g=void 0,k=void 0,O={ccaa:{},provincias:{},neighbourhoods:{},censussections:{}},j=void 0,C=void 0,G=void 0,x={granularity:r(".granularity"),variables:r(".variables"),types:r(".types"),colors:r(".colors"),classes:r(".classes")},w={type:"sequential",color:"OrRd",classes:8};m=e.map("map").setView([40.417049,-3.703525],6),v=e.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',id:"mapbox.light",accessToken:"pk.eyJ1IjoibXluZGZsYW1lIiwiYSI6ImNpbXJ1am85cDAwNGx2OW0xbnU0amdkZHgifQ.56NzZw6OPm41VEqhaqGHAA"}).addTo(m),h=e.topoJson(null,{onEachFeature:p,style:s}).addTo(m),g=e.control(),g.onAdd=function(a){return this._div=e.DomUtil.create("div","info"),this.update(),this._div},g.update=function(e){var a="";if(e)for(var r in e)e.hasOwnProperty(r)&&(a+=r+": "+e[r]+"<br>");else a="Hover over an area";this._div.innerHTML="<h4>Area Data</h4>"+a},g.addTo(m),k=e.control({position:"bottomright"}),k.onAdd=function(a){for(var r=e.DomUtil.create("div","info legend"),o=0;o<j.length;o++){var n=i(j[o]),t=void 0,s=void 0;G===y.population?(s=.001,t="k"):G!==y.pmen&&G!==y.pforeigners||(s=100,t="%");var l=j[o]*s,c=j[o+1]*s,u=c?"&ndash;"+c.toFixed(0)+t+"<br>":"+";r.innerHTML+='<i style="background:'+n+'"></i>'+l.toFixed(0)+t+u}return r},fetch("./api/v1/token",{credentials:"same-origin"}).then(function(e){return e.text()}).then(function(a){fetch("./api/v1/map?country=spain&region=all&city=all&granularity=ccaa&q=q1e4&sp=sp100&token="+a).then(function(e){200===e.status&&e.json().then(function(e){O.ccaa=e,u({granularity:f.ccaa,variable:y.population}),r.each(x,function(e,a){a.find("button").removeClass("disabled")}),x.granularity.find(".ca").on("click",function(e){u({granularity:f.ccaa,variable:G})}).removeClass("disabled")})}),fetch("./api/v1/venues?token="+a).then(function(e){return e.json()}).then(function(a){b=e.markerClusterGroup({disableClusteringAtZoom:18}),a.filter(function(e){return e.lat&&e.lon}).forEach(function(a){e.marker([a.lat,a.lon]).addTo(b).bindPopup("<div>"+a.ds_pdv+"<br>"+(a.twitter_statuses||0)+"<br>"+(a.foursquare_usercount||0)+"</div>")}),m.addLayer(b);var r=Math.max.apply(Math,_toConsumableArray(a.map(function(e){return e.foursquare_usercount}))),o=e.heatLayer(a.filter(function(e){return e.lat&&e.lon&&e.foursquare_usercount}).map(function(e){return[e.lat,e.lon,parseInt(e.foursquare_usercount,10)]}),{radius:25,max:r});m.addLayer(o)})["catch"](function(e){return console.log(e)})}),x.colors.html(t()).foundation(),x.granularity.on("click",".no",function(e){u({granularity:f.empty,variable:G})}),x.variables.on("click",".no",function(e){u({granularity:C,variable:y.empty})}),x.variables.on("click",".po",function(e){u({granularity:C,variable:y.population})}),x.variables.on("click",".pm",function(e){u({granularity:C,variable:y.pmen})}),x.variables.on("click",".pf",function(e){u({granularity:C,variable:y.pforeigners})}),x.types.on("click",".color-type",function(e){w.type=e.target.firstChild.nodeValue.toLowerCase(),x.colors.html(t()).foundation()}),x.colors.on("click",".color-name",function(e){var a=e.currentTarget.className.replace("color-name ",""),r=Math.max.apply(Math,_toConsumableArray(Object.keys(o[a])));w.color=a,w.classes=w.classes>r?r:w.classes,u({granularity:C,variable:G})}),x.classes.on("click",".color-classes",function(e){r(e.currentTarget.firstChild).hasClass("disabled")||(w.classes=e.target.firstChild.nodeValue,u({granularity:C,variable:G}))})}(L,topojson,$,colorbrewer);