"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var a=0,n=Array(e.length);a<e.length;a++)n[a]=e[a];return n}return Array.from(e)}!function(e,a,n,r){function o(e){for(var a=[],n=e/(A.classes-1),r=0;r<=A.classes-1;r++)a.push(n*r);return a}function t(){return Object.keys(r).filter(function(e){return"sequential"===A.type?["Blues","Greens","Greys","Oranges","Purples","Reds","BuGn","BuPu","GnBu","OrRd","PuBu","PuBuGn","PuRd","RdPu","YlGn","YlGn","YlGnBu","YlOrBr","YlOrRd"].indexOf(e)>=0:"diverging"===A.type?["BrBG","PiYG","PRGn","PuOr","RdBu","RdGy","RdYlBu","RdYlGn","Spectral"].indexOf(e)>=0:"qualitative"===A.type?["Accent","Dark2","Paired","Pastel1","Pastel2","Set1","Set2","Set3"].indexOf(e)>=0:!1}).map(function(e,a,n){var o=r[e][5],t="";return 0===a&&(t+='<ul class="menu dropdown" data-dropdown-menu><li class="is-dropdown-submenu-parent"><a href="#">Colors</a><ul class="menu">'),"YlGn"===e?(t+='<li class="is-dropdown-submenu-parent"><a href="#">Multi-hue</a><ul class="menu">',t+='<li><a href="#" class="'+e+'"><div class="color-container">',t+=o.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"):"Purples"===e?(t+="</ul></li>",t+='<li class="is-dropdown-submenu-parent"><a href="#">Single hue</a><ul class="menu">',t+='<li><a href="#" class="'+e+'"><div class="color-container">',t+=o.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"):(t+='<li><a href="#" class="'+e+'"><div class="color-container">',t+=o.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"),a===n.length-1&&(t+="</ul></li>",t+="</ul></li></ul>"),t}).join("")}function i(e){var a=r[A.color][A.classes];return j.reduce(function(n,r,o){return e>=r?a[o]:n},a[0])}function s(e){return{fillColor:i(e.properties.demography[G]),weight:1,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}function l(a){var n=a.target;n.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.7}),e.Browser.ie||e.Browser.opera||n.bringToFront(),g.update(n.feature.properties)}function c(e){b.resetStyle(e.target),g.update()}function u(e){var a=e?e.granularity||null:null,t=e?e.variable||null:null;if(C=a,G=t,b.clearLayers(),h.removeControl(k),a!==f.empty){var i=Object.keys(f)[a],s=Object.keys(O[i].objects)[0];j=o(G===v.pmen||G===v.pforeigners?1:O[i].objects[s].geometries.reduce(function(e,a){return Math.max(a.properties.demography[t],e)},0)),b.addData(O[i])}a!==f.empty&&t!==v.empty&&h.addControl(k);var l=Math.max.apply(Math,_toConsumableArray(Object.keys(r[A.color]))),c=2;w.classes.find("ul").children().each(function(e,a){var r=n(a);l>=e+c+1?r.removeClass("disabled"):r.addClass("disabled")})}function d(e){h.fitBounds(e.target.getBounds()),C<Object.keys(f).length-1&&u({granularity:C+1,variable:G})}function p(e,a){a.on({mouseover:l,mouseout:c,click:d})}n(document).foundation(),e.TopoJSON=e.GeoJSON.extend({addData:function(n){if("Topology"===n.type)for(var r in n.objects){var o=a.feature(n,n.objects[r]);e.GeoJSON.prototype.addData.call(this,o)}else e.GeoJSON.prototype.addData.call(this,n);return this}}),e.topoJson=function(a,n){return new e.TopoJSON(a,n)};var f=Object.freeze({empty:-1,ccaa:1,provincias:2,neighbourhoods:3,censussections:4}),v=Object.freeze({empty:"empty",population:"poblacion",pmen:"prop_hombres",pforeigners:"prop_origen_extranjero"}),h=void 0,y=void 0,b=void 0,m=void 0,g=void 0,k=void 0,O={ccaa:{},provincias:{},neighbourhoods:{},censussections:{}},j=void 0,C=void 0,G=void 0,w={granularity:n(".granularity"),variables:n(".variables"),types:n(".types"),colors:n(".colors"),classes:n(".classes")},A={type:"sequential",color:"OrRd",classes:8};h=e.map("map").setView([40.417049,-3.703525],6),y=e.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',id:"mapbox.light",accessToken:"pk.eyJ1IjoibXluZGZsYW1lIiwiYSI6ImNpbXJ1am85cDAwNGx2OW0xbnU0amdkZHgifQ.56NzZw6OPm41VEqhaqGHAA"}).addTo(h),b=e.topoJson(null,{onEachFeature:p,style:s}).addTo(h),g=e.control(),g.onAdd=function(a){return this._div=e.DomUtil.create("div","info"),this.update(),this._div},g.update=function(e){var a="";if(e)for(var n in e)e.hasOwnProperty(n)&&(a+=n+": "+e[n]+"<br>");else a="Hover over an area";this._div.innerHTML="<h4>Area Data</h4>"+a},g.addTo(h),k=e.control({position:"bottomright"}),k.onAdd=function(a){for(var n=e.DomUtil.create("div","info legend"),r=0;r<j.length;r++){var o=i(j[r]),t=void 0,s=void 0;G===v.population?(s=.001,t="k"):G!==v.pmen&&G!==v.pforeigners||(s=100,t="%");var l=j[r]*s,c=j[r+1]*s,u=c?"&ndash;"+c.toFixed(0)+t+"<br>":"+";n.innerHTML+='<i style="background:'+o+'"></i>'+l.toFixed(0)+t+u}return n},fetch("./api/v1.0/ccaa").then(function(e){200===e.status&&e.json().then(function(e){O.ccaa=e,u({granularity:f.ccaa,variable:v.population}),n.each(w,function(e,a){a.find("button").removeClass("disabled")}),w.granularity.find(".ca").on("click",function(e){u({granularity:f.ccaa,variable:G})}).removeClass("disabled")})}),fetch("./api/v1.0/provincias").then(function(e){200===e.status&&e.json().then(function(e){O.provincias=e,w.granularity.find(".pv").on("click",function(e){u({granularity:f.provincias,variable:G})}).removeClass("disabled")})}),fetch("./api/v1.0/barrios_madrid").then(function(e){200===e.status&&e.json().then(function(e){O.neighbourhoods=e,w.granularity.find(".nh").on("click",function(e){u({granularity:f.neighbourhoods,variable:G})}).removeClass("disabled")})}),fetch("./api/v1.0/secciones_censales_madrid").then(function(e){200===e.status&&e.json().then(function(e){O.censussections=e,w.granularity.find(".cs").on("click",function(e){u({granularity:f.censussections,variable:G})}).removeClass("disabled")})}),fetch("./api/v1.0/horeca").then(function(a){200===a.status&&a.json().then(function(a){m=e.markerClusterGroup({disableClusteringAtZoom:17}),a.forEach(function(a){e.marker([a.lat,a.lon]).addTo(m).bindPopup(a.ds_pdv)}),h.addLayer(m)})}),w.colors.html(t()).foundation(),w.granularity.on("click",".no",function(e){u({granularity:f.empty,variable:G})}),w.variables.on("click",".no",function(e){u({granularity:C,variable:v.empty})}),w.variables.on("click",".po",function(e){u({granularity:C,variable:v.population})}),w.variables.on("click",".pm",function(e){u({granularity:C,variable:v.pmen})}),w.variables.on("click",".pf",function(e){u({granularity:C,variable:v.pforeigners})}),w.types.on("click","li",function(e){A.type=e.target.firstChild.nodeValue.toLowerCase(),w.colors.find("ul").html(t()).foundation()}),w.colors.on("click","li",function(e){var a=e.currentTarget.firstChild.className,n=Math.max.apply(Math,_toConsumableArray(Object.keys(r[a])));A.color=a,A.classes=A.classes>n?n:A.classes,u({granularity:C,variable:G})}),w.classes.on("click","li",function(e){A.classes=e.target.firstChild.nodeValue,u({granularity:C,variable:G})})}(L,topojson,$,colorbrewer);