"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}!function(e,t,a){function r(e){return""+e[0].toUpperCase()+e.slice(1)}function n(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,new Error(t)}function o(e,t){var a=t.twitter,r=t.foursquare;return"\n      <div>\n        "+e+"\n        <br>\n        "+a.statuses+"\n        <br>\n        "+r.usercount+"\n      </div>\n    "}function i(t,a,n){return e('\n        <li>\n          <span class="fa fa-times delete"></span>\n          <span>'+r(t)+": "+r(a)+" - "+r(n)+"</span>\n        </li>").data("type",t).data("area",a).data("name",n)}function c(e){var a={statuses:e.twitter_statuses||0},r={usercount:e.foursquare_usercount||0};return t.marker([e.lat,e.lon]).bindPopup(o(e.ds_pdv,{twitter:a,foursquare:r}))}function s(e){return g.filter(function(t){var a=!0,r=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(a=(o=i.next()).done);a=!0){var c=o.value;if(t[c.area].toLowerCase()===c.name)return!0}}catch(s){r=!0,n=s}finally{try{!a&&i["return"]&&i["return"]()}finally{if(r)throw n}}return!1}).filter(function(e){return e.lat&&e.lon}).map(c)}function l(e,t,a){return g.filter(function(e){return e.lat&&e.lon&&e[a]}).filter(function(a){return a[e].toLowerCase()===t}).map(function(e){return[e.lat,e.lon,e[a]]})}function u(){return fetch("./api/v1/token",{credentials:"same-origin"}).then(n).then(function(e){return e.text()})}function m(e,t,a){return fetch("./api/v1/venues?area="+t+"&name="+a+"&token="+e).then(n).then(function(e){return e.json()}).then(function(e){var r=g.map(function(e){return e.cd_pdv}),n=e.filter(function(e){return-1===r.indexOf(e.cd_pdv)});g.push.apply(g,_toConsumableArray(n)),y.push({area:t,name:a})})}function f(e,t,a,r){return fetch("./api/v1/map?area="+t+"&name="+a+"&gran="+r+"&token="+e).then(n).then(function(e){return e.json()}).then(function(e){return h.push({area:t,name:a,gran:r,shapes:e})})}function d(e){return e>1e3?"#800026":e>500?"#BD0026":e>200?"#E31A1C":e>100?"#FC4E2A":e>50?"#FD8D3C":e>20?"#FEB24C":e>10?"#FED976":"#FFEDA0"}function v(){e(".control .markers").find("#marker-city").prop("checked",!0),e(".control .markers").find(".name").val(""),e(".select .markers").removeClass("active"),e(".control .markers").removeClass("active"),e(".control").removeClass("active"),e(".control .heatmaps").find("#heatmap-city").prop("checked",!0),e(".control .heatmaps").find(".name").val(""),e(".control .heatmaps").find(".variable").val(""),e(".select .heatmaps").removeClass("active"),e(".control .heatmaps").removeClass("active"),e(".control").removeClass("active"),e(".control .geometry").find("#geometry-city").prop("checked",!0),e(".control .geometry").find(".name").val(""),e(".control .geometry").find(".gran").val(""),e(".select .geometry").removeClass("active"),e(".control .geometry").removeClass("active"),e(".control").removeClass("active")}var p=Object.freeze({markers:"markers",heatmaps:"heatmaps",geometry:"geometry"}),g=[],y=[],h=[];e(document).foundation();var C=t.map("map",{zoomControl:!1}).setView([40.417049,-3.703525],6);t.control.zoom({position:"bottomleft"}).addTo(C);var k=t.control();k.onAdd=function(e){return this._div=t.DomUtil.create("div","info"),this.update(),this._div},k.update=function(e){var t="";if(e)for(var a in e)e.hasOwnProperty(a)&&(t+=a+": "+e[a]+"<br>");else t="Hover over an area";this._div.innerHTML="<h4>Area Data</h4>"+t};var b=t.control({position:"bottomright"});b.onAdd=function(e){for(var a=t.DomUtil.create("div","info legend"),r=[0,10,20,50,100,200,500,1e3],n=0;n<r.length;n++)a.innerHTML+='\n        <i style="background:'+d(r[n]+1)+'"></i>\n        <span>'+r[n]+(r[n+1]?"&ndash;"+r[n+1]+"<br>":"+")+"</span>";return a},t.TopoJSON=t.GeoJSON.extend({addData:function(e){if("Topology"===e.type)for(var r in e.objects){var n=a.feature(e,e.objects[r]);t.GeoJSON.prototype.addData.call(this,n)}else t.GeoJSON.prototype.addData.call(this,e);return this}}),t.topoJson=function(e,a){return new t.TopoJSON(e,a)};var w=(t.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',id:"mapbox.light",accessToken:"pk.eyJ1IjoibXluZGZsYW1lIiwiYSI6ImNpbXJ1am85cDAwNGx2OW0xbnU0amdkZHgifQ.56NzZw6OPm41VEqhaqGHAA"}).addTo(C),t.markerClusterGroup({disableClusteringAtZoom:18}).addTo(C)),D=[],A=[],T=u();e(".select").on("click",".markers",function(t){t.preventDefault(),e(t.currentTarget).addClass("active").siblings().removeClass("active"),e(".control .markers").addClass("active").siblings().removeClass("active"),e(".control").addClass("active")}).on("click",".markers.active",function(t){t.preventDefault(),e(t.currentTarget).removeClass("active").siblings().removeClass("active"),e(".control .markers").removeClass("active").siblings().removeClass("active"),e(".control").removeClass("active")}).on("click",".heatmaps",function(t){t.preventDefault(),e(t.currentTarget).addClass("active").siblings().removeClass("active"),e(".control .heatmaps").addClass("active").siblings().removeClass("active"),e(".control").addClass("active")}).on("click",".heatmaps.active",function(t){t.preventDefault(),e(t.currentTarget).removeClass("active").siblings().removeClass("active"),e(".control .heatmaps").removeClass("active").siblings().removeClass("active"),e(".control").removeClass("active")}).on("click",".geometry",function(t){t.preventDefault(),e(t.currentTarget).addClass("active").siblings().removeClass("active"),e(".control .geometry").addClass("active").siblings().removeClass("active"),e(".control").addClass("active")}).on("click",".geometry.active",function(t){t.preventDefault(),e(t.currentTarget).removeClass("active").siblings().removeClass("active"),e(".control .geometry").removeClass("active").siblings().removeClass("active"),e(".control").removeClass("active")}),e(".controls .layers").on("click",".delete",function(t){t.preventDefault();var a=e(t.currentTarget).parent().data("type"),r=e(t.currentTarget).parent().data("area"),n=e(t.currentTarget).parent().data("name");switch(a){case p.markers:e(t.currentTarget).parent().remove();var o=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===a});w.clearLayers(),w.addLayers(s(o));break;case p.heatmaps:var i=D.reduce(function(e,t,a){return t.area===r&&t.name===n?a:e},-1);-1!==i&&(C.removeLayer(D[i].heatmap),D=[].concat(_toConsumableArray(D.slice(0,i)),_toConsumableArray(D.slice(i+1))),e(t.currentTarget).parent().remove());break;case p.geometry:var c=A.reduce(function(e,t,a){return t.area===r&&t.name===n?a:e},-1);-1!==c&&(C.removeLayer(A[c].geometry),A=[].concat(_toConsumableArray(A.slice(0,c)),_toConsumableArray(A.slice(c+1))),e(t.currentTarget).parent().remove()),C.removeControl(k),C.removeControl(b),C.setView([40.417049,-3.703525],6)}}),e(".control .markers").on("click",".advanced",function(e){e.preventDefault()}).on("click",".add",function(t){t.preventDefault();var a=p.markers,r=e(".control .markers").find('input[type="radio"]:checked').val().trim().toLowerCase(),n=e(".control .markers").find(".name").val().trim().toLowerCase();if(r&&n){var o=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===a});if(!o.find(function(e){return e.area===r&&e.name===n})){e(".loading").toggle();var c=y.find(function(e){return e.area===r&&e.name===n})?Promise.resolve():T.then(function(e){return m(e,r,n)});c.then(function(){o.push({type:a,area:r,name:n}),w.clearLayers(),w.addLayers(s(o)),C.fitBounds(w.getBounds()),e(".controls .layers").find("ul").append(i(a,r,n)),v(),e(".loading").toggle()})["catch"](function(){return e(".loading").toggle()})}}}).on("click",".cancel",function(e){e.preventDefault(),v()}),e(".control .heatmaps").on("click",".advanced",function(e){e.preventDefault()}).on("click",".add",function(a){if(a.preventDefault(),0!==e(".control .heatmaps").find(".variable").prop("selectedIndex")){var r=p.heatmaps,n=e(".control .heatmaps").find('input[type="radio"]:checked').val().trim().toLowerCase(),o=e(".control .heatmaps").find(".name").val().trim().toLowerCase(),c=e(".control .heatmaps").find(".variable").val().trim().toLowerCase();if(n&&o&&c){var s=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===r});if(!s.find(function(e){return e.area===n&&e.name===o})){e(".loading").toggle();var u=y.find(function(e){return e.area===n&&e.name===o})?Promise.resolve():T.then(function(e){return m(e,n,o)});u.then(function(){var a=l(n,o,c),s=Math.max.apply(Math,_toConsumableArray(a.map(function(e){return e[2]}).sort(function(e,t){return t-e}).slice(.1*a.length))),u=t.heatLayer(a,{radius:25,max:s});u.addTo(C),D.push({area:n,name:o,heatmap:u}),e(".controls .layers").find("ul").append(i(r,n,o)),v(),e(".loading").toggle()})["catch"](function(){return e(".loading").toggle()})}}}}).on("click",".cancel",function(e){e.preventDefault(),v()}),e(".control .geometry").on("click",".advanced",function(e){e.preventDefault()}).on("click",".add",function(a){if(a.preventDefault(),0!==e(".control .geometry").find(".variable").prop("selectedIndex")){var r=p.geometry,n=e(".control .geometry").find('input[type="radio"]:checked').val().trim().toLowerCase(),o=e(".control .geometry").find(".name").val().trim().toLowerCase(),c=e(".control .geometry").find(".gran").val().trim().toLowerCase(),s=e(".control .geometry").find(".variable").val().trim().toLowerCase();if(n&&o&&c&&s){var l=e(".controls .layers").find("li").toArray().map(function(t){return{type:e(t).data("type"),area:e(t).data("area"),name:e(t).data("name")}}).filter(function(e){return e.type===r});if(!l.length){e(".loading").toggle();var u=-1===h.filter(function(e){return e.area===n}).map(function(e){return e.name}).indexOf(o)?T.then(function(e){return f(e,n,o,c)}):Promise.resolve();u.then(function(){var a=h.find(function(e){return e.area===n&&e.name===o&&e.gran===c}).shapes,l=t.topoJson(null,{onEachFeature:function(e,a){a.on({mouseover:function(e){e.target.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.7}),t.Browser.ie||t.Browser.opera||e.target.bringToFront(),k.update(e.target.feature.properties)},mouseout:function(e){l.resetStyle(e.target),k.update()},click:function(e){C.fitBounds(e.target.getBounds())}})},style:function(e){return{fillColor:d(e.properties[s]),fillOpacity:.7,weight:1,opacity:1,color:"white",dashArray:"3"}}}).addData(a).addTo(C);A.push({area:n,name:o,geometry:l}),k.addTo(C),b.addTo(C),C.fitBounds(l.getBounds()),e(".controls .layers").find("ul").append(i(r,n,o)),v(),e(".loading").toggle()})["catch"](function(){return e(".loading").toggle()})}}}}).on("click",".cancel",function(e){e.preventDefault(),v()})}($,L,topojson);