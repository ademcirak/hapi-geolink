"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)}!function(t,e){var a="",n={saved:[],active:[]},r={countries:[],regions:[],cities:[]};t(document).foundation();var o=e.map("map").setView([40.417049,-3.703525],6),i=(e.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',id:"mapbox.light",accessToken:"pk.eyJ1IjoibXluZGZsYW1lIiwiYSI6ImNpbXJ1am85cDAwNGx2OW0xbnU0amdkZHgifQ.56NzZw6OPm41VEqhaqGHAA"}).addTo(o),e.markerClusterGroup({disableClusteringAtZoom:18}).addTo(o)),s=[],c=fetch("./api/v1/token",{credentials:"same-origin"}).then(function(t){return t.text()}).then(function(e){a=e,setTimeout(function(){return t(".loading").toggle()},1e3)})["catch"](function(t){return console.log(t)});t(".map-controls .toggle").on("click",function(e){e.preventDefault(),t(".map-controls").toggleClass("open"),t(".leaflet-left").toggleClass("open")}),t(".control-active").on("click",".delete",function(a){a.preventDefault();var r=t(a.currentTarget).siblings("span"),c=t(r[0]).text(),l=t(r[1]).text().toLowerCase();switch(c){case"Marker Layer":var p=n.active.filter(function(t){return t.city.toLowerCase()!==l});n.active=p;var u=p.map(function(t){return e.marker([t.lat,t.lon]).bindPopup("<div>"+t.ds_pdv+"<br>"+(t.twitter_statuses||0)+"<br>"+(t.foursquare_usercount||0)+"</div>")});t(a.currentTarget).parent().remove(),i.clearLayers(),i.addLayers(u);break;case"Heatmap Layer":var f=s.map(function(t){return t.city}),d=f.indexOf(l);o.removeLayer(s[d].heatmap),s=[].concat(_toConsumableArray(s.slice(0,d)),_toConsumableArray(s.slice(d+1))),t(a.currentTarget).parent().remove()}}),t(".control-markers .submit").on("click",function(o){o.preventDefault();var s=n.saved.map(function(t){return t.cd_pdv}),l=n.active.map(function(t){return t.cd_pdv}),p=t(".control-markers .city").val().toLowerCase();if(p)if(-1===r.cities.indexOf(p))t(".loading").toggle(),c.then(function(){fetch("./api/v1/venues?city="+p+"&token="+a).then(function(t){return t.json()}).then(function(a){r.cities.push(p);var o=a.filter(function(t){return-1===s.indexOf(t.cd_pdv)}).map(function(t){return n.saved.push(t),t}).filter(function(t){return t.lat&&t.lon}).filter(function(t){return-1===l.indexOf(t.cd_pdv)}).map(function(t){return n.active.push(t),e.marker([t.lat,t.lon]).bindPopup("<div>"+t.ds_pdv+"<br>"+(t.twitter_statuses||0)+"<br>"+(t.foursquare_usercount||0)+"</div>")});o.length&&(i.addLayers(o),t(".control-active ul").append('<li><span class="fa fa-times delete"></span> <span class="type">Marker Layer</span> - <span class="city">'+p[0].toUpperCase()+p.slice(1)+"</span></li>"),t(".control-markers .city").val("")),t(".loading").toggle()})["catch"](function(e){t(".loading").toggle(),console.log(e)})});else{var u=n.saved.filter(function(t){return t.city.toLowerCase()===p}).filter(function(t){return t.lat&&t.lon}).filter(function(t){return-1===l.indexOf(t.cd_pdv)}).map(function(t){return n.active.push(t),e.marker([t.lat,t.lon]).bindPopup("<div>"+t.ds_pdv+"<br>"+(t.twitter_statuses||0)+"<br>"+(t.foursquare_usercount||0)+"</div>")});u.length&&(i.addLayers(u),t(".control-active ul").append('<li><span class="fa fa-times delete"></span> <span class="type">Marker Layer</span> - <span class="city">'+p[0].toUpperCase()+p.slice(1)+"</span></li>"),t(".control-markers .city").val(""))}}),t(".control-heatmaps .submit").on("click",function(i){i.preventDefault();var l=n.saved.map(function(t){return t.cd_pdv}),p=(n.active.map(function(t){return t.cd_pdv}),t(".control-heatmaps .city").val().toLowerCase()),u=t(".control-heatmaps .variable").val().toLowerCase();if(p&&u&&-1===s.map(function(t){return t.city}).indexOf(p))if(-1===r.cities.indexOf(p))t(".loading").toggle(),c.then(function(){fetch("./api/v1/venues?city="+p+"&token="+a).then(function(t){return t.json()}).then(function(a){r.cities.push(p);var i=a.filter(function(t){return-1===l.indexOf(t.cd_pdv)}).map(function(t){return n.saved.push(t),t}).filter(function(t){return t.lat&&t.lon&&t[u]}).map(function(t){return[t.lat,t.lon,parseInt(t[u],10)]});if(i.length){var c=Math.max.apply(Math,_toConsumableArray(i.map(function(t){return t[2]})))/i.length,f=e.heatLayer(i,{radius:25,max:c});f.addTo(o),s.push({city:p,heatmap:f}),t(".control-active ul").append('<li><span class="fa fa-times delete"></span> <span class="type">Heatmap Layer</span> - <span class="city">'+p[0].toUpperCase()+p.slice(1)+"</span></li>"),t(".control-heatmaps .city").val(""),t(".control-heatmaps .variable").val("")}t(".loading").toggle()})["catch"](function(e){t(".loading").toggle(),console.log(e)})});else{var f=n.saved.filter(function(t){return t.city.toLowerCase()===p}).filter(function(t){return t.lat&&t.lon&&t[u]}).map(function(t){return[t.lat,t.lon,parseInt(t[u],10)]});if(f.length){var d=Math.max.apply(Math,_toConsumableArray(f.map(function(t){return t[2]})))/f.length,v=e.heatLayer(f,{radius:25,max:d});v.addTo(o),s.push({city:p,heatmap:v}),t(".control-active ul").append('<li><span class="fa fa-times delete"></span> <span class="type">Heatmap Layer</span> - <span class="city">'+p[0].toUpperCase()+p.slice(1)+"</span></li>"),t(".control-heatmaps .city").val(""),t(".control-heatmaps .variable").val("")}}})}($,L);