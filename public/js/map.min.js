"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,a=Array(e.length);n<e.length;n++)a[n]=e[n];return a}return Array.from(e)}!function(e,n,a,o){function r(e){for(var n=[],a=e/(x.classes-1),o=0;o<=x.classes-1;o++)n.push(a*o);return n}function t(){return Object.keys(o).filter(function(e){return"sequential"===x.type?["Blues","Greens","Greys","Oranges","Purples","Reds","BuGn","BuPu","GnBu","OrRd","PuBu","PuBuGn","PuRd","RdPu","YlGn","YlGn","YlGnBu","YlOrBr","YlOrRd"].indexOf(e)>=0:"diverging"===x.type?["BrBG","PiYG","PRGn","PuOr","RdBu","RdGy","RdYlBu","RdYlGn","Spectral"].indexOf(e)>=0:"qualitative"===x.type?["Accent","Dark2","Paired","Pastel1","Pastel2","Set1","Set2","Set3"].indexOf(e)>=0:!1}).map(function(e,n,a){var r=o[e][5],t="";return 0===n&&(t+='<ul class="menu dropdown" data-dropdown-menu><li class="is-dropdown-submenu-parent"><a href="#">Colors</a><ul class="menu">'),"YlGn"===e?(t+='<li class="is-dropdown-submenu-parent"><a href="#">Multi-hue</a><ul class="menu">',t+='<li><a href="#" class="color-name '+e+'"><div class="color-container">',t+=r.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"):"Purples"===e?(t+="</ul></li>",t+='<li class="is-dropdown-submenu-parent"><a href="#">Single hue</a><ul class="menu">',t+='<li><a href="#" class="color-name '+e+'"><div class="color-container">',t+=r.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"):(t+='<li><a href="#" class="color-name '+e+'"><div class="color-container">',t+=r.map(function(e){return'<i style="background:'+e+'" class="color"></i>'}).join(""),t+="</div></a></li>"),n===a.length-1&&(t+="</ul></li>",t+="</ul></li></ul>"),t}).join("")}function i(e){var n=o[x.color][x.classes];return j.reduce(function(a,o,r){return e>=o?n[r]:a},n[0])}function s(e){return{fillColor:i(e.properties.demography[G]),weight:1,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}function l(n){var a=n.target;a.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.7}),e.Browser.ie||e.Browser.opera||a.bringToFront(),g.update(a.feature.properties)}function c(e){m.resetStyle(e.target),g.update()}function u(e){var n=e?e.granularity||null:null,t=e?e.variable||null:null;if(C=n,G=t,m.clearLayers(),v.removeControl(k),n!==f.empty){var i=Object.keys(f)[n],s=Object.keys(O[i].objects)[0];j=r(G===h.pmen||G===h.pforeigners?1:O[i].objects[s].geometries.reduce(function(e,n){return Math.max(n.properties.demography[t],e)},0)),m.addData(O[i])}n!==f.empty&&t!==h.empty&&v.addControl(k);var l=Math.max.apply(Math,_toConsumableArray(Object.keys(o[x.color]))),c=2;w.classes.find(".color-classes").each(function(e,n){var o=a(n).find("a");l>=e+c+1?o.removeClass("disabled"):o.addClass("disabled")})}function d(e){v.fitBounds(e.target.getBounds()),C<Object.keys(f).length-1&&u({granularity:C+1,variable:G})}function p(e,n){n.on({mouseover:l,mouseout:c,click:d})}a(document).foundation(),e.TopoJSON=e.GeoJSON.extend({addData:function(a){if("Topology"===a.type)for(var o in a.objects){var r=n.feature(a,a.objects[o]);e.GeoJSON.prototype.addData.call(this,r)}else e.GeoJSON.prototype.addData.call(this,a);return this}}),e.topoJson=function(n,a){return new e.TopoJSON(n,a)};var f=Object.freeze({empty:-1,ccaa:1,provincias:2,neighbourhoods:3,censussections:4}),h=Object.freeze({empty:"empty",population:"poblacion",pmen:"prop_hombres",pforeigners:"prop_origen_extranjero"}),v=void 0,y=void 0,m=void 0,b=void 0,g=void 0,k=void 0,O={ccaa:{},provincias:{},neighbourhoods:{},censussections:{}},j=void 0,C=void 0,G=void 0,w={granularity:a(".granularity"),variables:a(".variables"),types:a(".types"),colors:a(".colors"),classes:a(".classes")},x={type:"sequential",color:"OrRd",classes:8};v=e.map("map").setView([40.417049,-3.703525],6),y=e.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',id:"mapbox.light",accessToken:"pk.eyJ1IjoibXluZGZsYW1lIiwiYSI6ImNpbXJ1am85cDAwNGx2OW0xbnU0amdkZHgifQ.56NzZw6OPm41VEqhaqGHAA"}).addTo(v),m=e.topoJson(null,{onEachFeature:p,style:s}).addTo(v),g=e.control(),g.onAdd=function(n){return this._div=e.DomUtil.create("div","info"),this.update(),this._div},g.update=function(e){var n="";if(e)for(var a in e)e.hasOwnProperty(a)&&(n+=a+": "+e[a]+"<br>");else n="Hover over an area";this._div.innerHTML="<h4>Area Data</h4>"+n},g.addTo(v),k=e.control({position:"bottomright"}),k.onAdd=function(n){for(var a=e.DomUtil.create("div","info legend"),o=0;o<j.length;o++){var r=i(j[o]),t=void 0,s=void 0;G===h.population?(s=.001,t="k"):G!==h.pmen&&G!==h.pforeigners||(s=100,t="%");var l=j[o]*s,c=j[o+1]*s,u=c?"&ndash;"+c.toFixed(0)+t+"<br>":"+";a.innerHTML+='<i style="background:'+r+'"></i>'+l.toFixed(0)+t+u}return a},fetch("./api/v1/token",{credentials:"same-origin"}).then(function(e){return e.text()}).then(function(n){fetch("./api/v1/ccaa?token="+n).then(function(e){200===e.status&&e.json().then(function(e){O.ccaa=e,u({granularity:f.ccaa,variable:h.population}),a.each(w,function(e,n){n.find("button").removeClass("disabled")}),w.granularity.find(".ca").on("click",function(e){u({granularity:f.ccaa,variable:G})}).removeClass("disabled")})}),fetch("./api/v1/provincias?token="+n).then(function(e){return e.json()}).then(function(e){O.provincias=e,w.granularity.find(".pv").on("click",function(e){u({granularity:f.provincias,variable:G})}).removeClass("disabled")})["catch"](function(e){return console.log(e)}),fetch("./api/v1/barrios_madrid?token="+n).then(function(e){return e.json()}).then(function(e){O.neighbourhoods=e,w.granularity.find(".nh").on("click",function(e){u({granularity:f.neighbourhoods,variable:G})}).removeClass("disabled")})["catch"](function(e){return console.log(e)}),fetch("./api/v1/secciones_censales_madrid?token="+n).then(function(e){return e.json()}).then(function(e){O.censussections=e,w.granularity.find(".cs").on("click",function(e){u({granularity:f.censussections,variable:G})}).removeClass("disabled")})["catch"](function(e){return console.log(e)}),fetch("./api/v1/horeca?token="+n).then(function(e){return e.json()}).then(function(n){b=e.markerClusterGroup({disableClusteringAtZoom:17}),n.filter(function(e){return e.lat&&e.lon}).forEach(function(n){e.marker([n.lat,n.lon]).addTo(b).bindPopup(n.ds_pdv)}),v.addLayer(b)})["catch"](function(e){return console.log(e)})}),w.colors.html(t()).foundation(),w.granularity.on("click",".no",function(e){u({granularity:f.empty,variable:G})}),w.variables.on("click",".no",function(e){u({granularity:C,variable:h.empty})}),w.variables.on("click",".po",function(e){u({granularity:C,variable:h.population})}),w.variables.on("click",".pm",function(e){u({granularity:C,variable:h.pmen})}),w.variables.on("click",".pf",function(e){u({granularity:C,variable:h.pforeigners})}),w.types.on("click",".color-type",function(e){x.type=e.target.firstChild.nodeValue.toLowerCase(),w.colors.html(t()).foundation()}),w.colors.on("click",".color-name",function(e){var n=e.currentTarget.className.replace("color-name ",""),a=Math.max.apply(Math,_toConsumableArray(Object.keys(o[n])));x.color=n,x.classes=x.classes>a?a:x.classes,u({granularity:C,variable:G})}),w.classes.on("click",".color-classes",function(e){a(e.currentTarget.firstChild).hasClass("disabled")||(x.classes=e.target.firstChild.nodeValue,u({granularity:C,variable:G}))})}(L,topojson,$,colorbrewer);